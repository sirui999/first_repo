## Library
library(readr)
library(here)
library(dplyr)
library(janitor)
library(tidyverse)
library(patchwork)
library(ggResidpanel)
library(ggeffects)
library(jtools)
library(lme4)
library(ggeffects)
library(lmerTest)

## Data - 完整的修正版本
data <- read_csv2(
  here("H:/PhD_Arbeit/WP1/Thesis/DrY/Data", "DrY_ID_AS_PH_BM_IG.csv"),
  show_col_types = FALSE,
  locale = locale(encoding = "UTF-8", decimal_mark = ",", grouping_mark = ".")
) %>%
  clean_names() %>%
  # 先将所有化合物列转换为数值型
  mutate(across(ends_with("_g_g"), ~ as.numeric(.))) %>%
# Create chamber variable if not already present
  mutate(chamber = factor(paste(cabin, desk, sep = "_")))%>%
  # set factors
  mutate(
    id_greenhouse = as.factor(id_greenhouse),
    community = as.factor(community),
    phase = as.factor(replicate),
    drought_level = factor(drought_level, levels = c("1", "2", "3", "4", "5")),
    species_richness = as.factor(species_richness),
    pla_lan = as.factor(pla_lan),
    bel_per = as.factor(bel_per),
    harvest = as.factor(ernte)
  ) %>%
  # recode drought and log transform
  mutate(
    waterAv = recode_factor(drought_level,
                           "1" = 10,
                           "2" = 20,
                           "3" = 30,
                           "4" = 60,
                           "5" = 100),
    waterAv = as.numeric(as.character(waterAv)),
    waterAv_log = log10(waterAv)
  ) %>%
  # 重命名化合物列，移除 "_g_g" 后缀
  rename_with(~ gsub("_g_g$", "", .x))

# 检查数据结构
cat("数据维度：", dim(data), "\n")
cat("列名：\n")
print(names(data))

## 创建长格式数据
# 定义化合物列
compound_cols <- c("ja", "aba", "ja_ile", "opda", "oh_ja", "sa_glu_mz137", "sulfo_ja")

# 再次确保所有化合物列都是数值型
data <- data %>%
  mutate(across(all_of(intersect(compound_cols, names(data))), ~ as.numeric(.)))

# 创建长格式数据
data_long <- data %>%
  pivot_longer(
    names_to = "compound",
    values_to = "concentration",
    cols = all_of(intersect(compound_cols, names(data)))
  )
# 转换 phase
data_long <- data_long %>%
  mutate(
    phase = case_when(
      as.character(phase) == "1" ~ "Resistance",
      as.character(phase) == "2" ~ "Recovery",
      TRUE ~ as.character(phase)
    ),
    phase = factor(phase, levels = c("Resistance", "Recovery"))
  )

# 重命名 species_diversity
if (!"species_diversity" %in% names(data_long) && "species_richness" %in% names(data_long)) {
  data_long <- data_long %>%
    rename(species_diversity = species_richness)
}

# 移除浓度缺失值
data_long <- data_long %>%
  filter(!is.na(concentration))

cat("\n长格式数据创建成功！\n")
cat("数据维度：", dim(data_long), "\n")
cat("化合物类型：\n")
print(table(data_long$compound))
cat("\n阶段分布：\n")
print(table(data_long$phase))

## 现在可以开始你的分析
## 1. Visualization - 首先测试 Plantago

cat("\n=== 创建 Plantago lanceolata 图形 ===\n")


## Visualization

plalan_resistance<-ggplot(data_long%>%
                   filter(pla_lan==1&
                           phase=="Resistance"),
       aes(waterAv_log,concentration,color=species_diversity))+
  geom_point(aes(color=species_diversity))+
  facet_wrap(~compound,scales = "free_y")+
  theme_classic()+
  theme(legend.position = "top")+
  ylab("Concentration µg/g")+
  xlab("Water field availability (log10)")+
  ggtitle("Plantago resistance")

plalan_recovery<-ggplot(data_long%>%
                   filter(pla_lan==1&
                           phase=="Recovery"),
       aes(waterAv_log,concentration,color=species_diversity))+
  geom_point(aes(color=species_diversity))+
  facet_wrap(~compound,scales = "free_y")+
  theme_classic()+
  theme(legend.position = "top")+
  ylab("Concentration µg/g")+
  xlab("Water field availability (log10)")+
  ggtitle("Plantago recovery")


com_Plalan_plot <- plalan_resistance | plalan_recovery
print(com_Plalan_plot)

## 2. Bellis perennis 图形
cat("\n=== 创建 Bellis perennis 图形 ===\n")

belper_resistance<-ggplot(data_long%>%
                   filter(bel_per==1&
                           phase=="Resistance"),
       aes(waterAv_log,concentration,color=species_diversity))+
  geom_point(aes(color=species_diversity))+
  facet_wrap(~compound,scales = "free_y")+
  theme_classic()+
  theme(legend.position = "top")+
  ylab("Concentration µg/g")+
  xlab("Water field availability (log10)")+
  ggtitle("Bellis resistance")

belper_recovery<-ggplot(data_long%>%
                   filter(bel_per==1&
                           phase=="Recovery"),
       aes(waterAv_log,concentration,color=species_diversity))+
  geom_point(aes(color=species_diversity))+
  facet_wrap(~compound,scales = "free_y")+
  theme_classic()+
  theme(legend.position = "top")+
  ylab("Concentration µg/g")+
  xlab("Water field availability (log10)")+
  ggtitle("Bellis recovery")


com_belper_plot <- belper_resistance | belper_recovery
print(com_belper_plot)


## 3. 回归分析示例 - Plantago ABA
cat("\n=== Plantago ABA 回归分析 ===\n")
## Regressions
Plantago
ABA

pl_ABA<-data_long%>%
  filter(pla_lan==1,
         compound=="aba")


# Resistance----------------------------------------
pl_ABA_res<-pl_ABA%>%
  filter(phase=="Resistance")

if (nrow(pl_ABA_res) > 10) {
  # 添加小的常数避免 log(0)
  pl_ABA_res <- pl_ABA_res %>%
    mutate(concentration_adj = concentration + 1e-10)

# Model 1
res_null <- lmer(log10(concentration) ~ 1 + (1|chamber), data = pl_JA_res)
res_water <- lmer(log10(concentration) ~ waterAv_log + (1|chamber), data = pl_JA_res)
res_div <- lmer(log10(concentration) ~ waterAv_log + species_diversity + (1|chamber), 
                data = pl_JA_res)
res_water_div <- lmer(log10(concentration) ~ waterAv_log * species_diversity + (1|chamber),
                      data = pl_JA_res)

shapiro.test(resid(res_water_div))

# Model comparison using likelihood ratio tests (ANOVA)
anova(res_null, res_water, res_div, res_water_div, test = "LRT")

# Generate predictions (marginal effects, excluding random effects)
pred <- ggpredict(res_water_div, 
                  terms = c("waterAv_log", "species_diversity"),
                  type = "fixed")  # fixed effects only

# Create the plot
plot_plalan_res <- plot(pred) +
  geom_point(data = pl_JA_res,
             aes(x = waterAv_log, 
                 y = concentration,
                 color = species_diversity),
             size = 2,
             inherit.aes = FALSE) +
  geom_line(linewidth = 1) +
  theme_classic() +
  theme(legend.position = "top") +
  ylim(0, 0.25) +
  ylab("Concentration µg/g") +
  xlab("Water field availability (log)") +
  ggtitle("Resistance")

# Recovery----------------------------------------
pl_ABA_rec<-pl_ABA%>%
  filter(phase=="Recovery")
  
rec_null <- lmer(log10(concentration) ~ 1 + (1|chamber), data = pl_ABA_rec)
rec_water <- lmer(log10(concentration) ~ waterAv_log + (1|chamber), data = pl_ABA_rec)
rec_div <- lmer(log10(concentration) ~ waterAv_log + species_diversity + (1|chamber), 
                data = pl_ABA_rec)
rec_water_div <- lmer(log10(concentration) ~ waterAv_log * species_diversity + (1|chamber),
                      data = pl_ABA_rec)

shapiro.test(resid(rec_water_div))

# Model comparison using likelihood ratio tests (ANOVA)
anova(rec_null, rec_water, rec_div, rec_water_div, test = "LRT")

# Generate predictions (marginal effects, excluding random effects)
pred <- ggpredict(rec_water_div, 
                  terms = c("waterAv_log", "species_diversity"),
                  type = "fixed")  # fixed effects only

# Create the plot
plot_plalan_rec <- plot(pred) +
  geom_point(data = pl_ABA_rec,
             aes(x = waterAv_log, 
                 y = concentration,
                 color = species_diversity),
             size = 2,
             inherit.aes = FALSE) +
  geom_line(linewidth = 1) +
  theme_classic() +
  theme(legend.position = "top") +
  ylim(0, 0.25) +
  ylab("Concentration µg/g") +
  xlab("Water field availability (log)") +
  ggtitle("Recovery")


## JA

pl_JA<-data_long%>%
  filter(pla_lan==1,
         compound=="ja")


# Resistance----------------------------------------
pl_JA_res<-pl_JA%>%
  filter(phase=="Resistance")

# Model 1
res_null <- lmer(log10(concentration) ~ 1 + (1|chamber), data = pl_JA_res)
res_water <- lmer(log10(concentration) ~ waterAv_log + (1|chamber), data = pl_JA_res)
res_div <- lmer(log10(concentration) ~ waterAv_log + species_diversity + (1|chamber), 
                data = pl_JA_res)
res_water_div <- lmer(log10(concentration) ~ waterAv_log * species_diversity + (1|chamber),
                      data = pl_JA_res)

shapiro.test(resid(res_water_div))

# Model comparison using likelihood ratio tests (ANOVA)
anova(res_null, res_water, res_div, res_water_div, test = "LRT")

# Generate predictions (marginal effects, excluding random effects)
pred <- ggpredict(res_water_div, 
                  terms = c("waterAv_log", "species_diversity"),
                  type = "fixed")  # fixed effects only

# Create the plot
plot_plalan_res <- plot(pred) +
  geom_point(data = pl_JA_res,
             aes(x = waterAv_log, 
                 y = concentration,
                 color = species_diversity),
             size = 2,
             inherit.aes = FALSE) +
  geom_line(linewidth = 1) +
  theme_classic() +
  theme(legend.position = "top") +
  ylim(0, 0.25) +
  ylab("Concentration µg/g") +
  xlab("Water field availability (log)") +
  ggtitle("Resistance")

# Recovery----------------------------------------
pl_JA_rec<-pl_JA%>%
  filter(phase=="Recovery")
  
rec_null <- lmer(log10(concentration) ~ 1 + (1|chamber), data = pl_JA_rec)
rec_water <- lmer(log10(concentration) ~ waterAv_log + (1|chamber), data = pl_JA_rec)
rec_div <- lmer(log10(concentration) ~ waterAv_log + species_diversity + (1|chamber), 
                data = pl_JA_rec)
rec_water_div <- lmer(log10(concentration) ~ waterAv_log * species_diversity + (1|chamber),
                      data = pl_JA_rec)

shapiro.test(resid(rec_water_div))

# Model comparison using likelihood ratio tests (ANOVA)
anova(rec_null, rec_water, rec_div, rec_water_div, test = "LRT")

# Generate predictions (marginal effects, excluding random effects)
pred <- ggpredict(rec_water_div, 
                  terms = c("waterAv_log", "species_diversity"),
                  type = "fixed")  # fixed effects only

# Create the plot
plot_plalan_rec <- plot(pred) +
  geom_point(data = pl_JA_rec,
             aes(x = waterAv_log, 
                 y = concentration,
                 color = species_diversity),
             size = 2,
             inherit.aes = FALSE) +
  geom_line(linewidth = 1) +
  theme_classic() +
  theme(legend.position = "top") +
  ylim(0, 0.25) +
  ylab("Concentration µg/g") +
  xlab("Water field availability (log)") +
  ggtitle("Recovery")


## Plot

com_Plalan_plot <-  (plot_pla_ja_res |  plot_pla_ja_rec)+ 
  plot_annotation(title = "JA - Plantago lanceolata",
                  theme = theme(plot.title = element_text(hjust = 0.5)))
com_Plalan_plot

## Bellis
## ABA

bel_ABA<-data_long%>%
  filter(bel_per==1,
         compound=="aba")


# Resistance----------------------------------------
bel_ABA_res<-bel_ABA%>%
  filter(phase=="Resistance")

# Model 1
res_null <- lmer(log10(concentration) ~ 1 + (1|chamber), data = bel_ABA_res)
res_water <- lmer(log10(concentration) ~ waterAv_log + (1|chamber), data = bel_ABA_res)
res_div <- lmer(log10(concentration) ~ waterAv_log + species_diversity + (1|chamber), 
                data = bel_ABA_res)
res_water_div <- lmer(log10(concentration) ~ waterAv_log * species_diversity + (1|chamber),
                      data = bel_ABA_res)

shapiro.test(resid(res_water_div))

# Model comparison using likelihood ratio tests (ANOVA)
anova(res_null, res_water, res_div, res_water_div, test = "LRT")

# Generate predictions (marginal effects, excluding random effects)
pred <- ggpredict(res_water_div, 
                  terms = c("waterAv_log", "species_diversity"),
                  type = "fixed")  # fixed effects only

# Create the belot
belot_belalan_res <- belot(pred) +
  geom_point(data = bel_ABA_res,
             aes(x = waterAv_log, 
                 y = concentration,
                 color = species_diversity),
             size = 2,
             inherit.aes = FALSE) +
  geom_line(linewidth = 1) +
  theme_classic() +
  theme(legend.position = "top") +
  ylim(0, 0.25) +
  ylab("Concentration µg/g") +
  xlab("Water field availability (log)") +
  ggtitle("Resistance")


# Recovery----------------------------------------
bel_ABA_rec<-bel_ABA%>%
  filter(phase=="Recovery")
  
rec_null <- lmer(log10(concentration) ~ 1 + (1|chamber), data = bel_ABA_rec)
rec_water <- lmer(log10(concentration) ~ waterAv_log + (1|chamber), data = bel_ABA_rec)
rec_div <- lmer(log10(concentration) ~ waterAv_log + species_diversity + (1|chamber), 
                data = bel_ABA_rec)
rec_water_div <- lmer(log10(concentration) ~ waterAv_log * species_diversity + (1|chamber),
                      data = bel_ABA_rec)

shapiro.test(resid(rec_water_div))

# Model comparison using likelihood ratio tests (ANOVA)
anova(rec_null, rec_water, rec_div, rec_water_div, test = "LRT")

# Generate predictions (marginal effects, excluding random effects)
pred <- ggpredict(rec_water_div, 
                  terms = c("waterAv_log", "species_diversity"),
                  type = "fixed")  # fixed effects only

# Create the belot
belot_belalan_rec <- belot(pred) +
  geom_point(data = bel_ABA_rec,
             aes(x = waterAv_log, 
                 y = concentration,
                 color = species_diversity),
             size = 2,
             inherit.aes = FALSE) +
  geom_line(linewidth = 1) +
  theme_classic() +
  theme(legend.position = "top") +
  ylim(0, 0.25) +
  ylab("Concentration µg/g") +
  xlab("Water field availability (log)") +
  ggtitle("Recovery")


## Plot 

com_belper_plot <-  (plot_belper_res |  plot_belper_rec)+ 
  plot_annotation(title = "ABA - Belis perennis",
                  theme = theme(plot.title = element_text(hjust = 0.5)))
com_belper_plot

JA

bel_JA<-data_long%>%
  filter(bel_per==1,
         compound=="ja")


# Resistance----------------------------------------
bel_JA_res<-bel_JA%>%
  filter(phase=="Resistance")

# Model 1
res_null <- lmer(log10(concentration) ~ 1 + (1|chamber), data = bel_JA_res)
res_water <- lmer(log10(concentration) ~ waterAv_log + (1|chamber), data = bel_JA_res)
res_div <- lmer(log10(concentration) ~ waterAv_log + species_diversity + (1|chamber), 
                data = bel_JA_res)
res_water_div <- lmer(log10(concentration) ~ waterAv_log * species_diversity + (1|chamber),
                      data = bel_JA_res)

shapiro.test(resid(res_water_div))

# Model comparison using likelihood ratio tests (ANOVA)
anova(res_null, res_water, res_div, res_water_div, test = "LRT")

# Generate predictions (marginal effects, excluding random effects)
pred <- ggpredict(res_water_div, 
                  terms = c("waterAv_log", "species_diversity"),
                  type = "fixed")  # fixed effects only

# Create the belot
belot_belalan_res <- belot(pred) +
  geom_point(data = bel_JA_res,
             aes(x = waterAv_log, 
                 y = concentration,
                 color = species_diversity),
             size = 2,
             inherit.aes = FALSE) +
  geom_line(linewidth = 1) +
  theme_classic() +
  theme(legend.position = "top") +
  ylim(0, 0.25) +
  ylab("Concentration µg/g") +
  xlab("Water field availability (log)") +
  ggtitle("Resistance")


# Recovery----------------------------------------
bel_JA_rec<-bel_JA%>%
  filter(phase=="Recovery")
  
rec_null <- lmer(log10(concentration) ~ 1 + (1|chamber), data = bel_JA_rec)
rec_water <- lmer(log10(concentration) ~ waterAv_log + (1|chamber), data = bel_JA_rec)
rec_div <- lmer(log10(concentration) ~ waterAv_log + species_diversity + (1|chamber), 
                data = bel_JA_rec)
rec_water_div <- lmer(log10(concentration) ~ waterAv_log * species_diversity + (1|chamber),
                      data = bel_JA_rec)

shapiro.test(resid(rec_water_div))

# Model comparison using likelihood ratio tests (ANOVA)
anova(rec_null, rec_water, rec_div, rec_water_div, test = "LRT")

# Generate predictions (marginal effects, excluding random effects)
pred <- ggpredict(rec_water_div, 
                  terms = c("waterAv_log", "species_diversity"),
                  type = "fixed")  # fixed effects only

# Create the belot
belot_belalan_rec <- belot(pred) +
  geom_point(data = bel_JA_rec,
             aes(x = waterAv_log, 
                 y = concentration,
                 color = species_diversity),
             size = 2,
             inherit.aes = FALSE) +
  geom_line(linewidth = 1) +
  theme_classic() +
  theme(legend.position = "top") +
  ylim(0, 0.25) +
  ylab("Concentration µg/g") +
  xlab("Water field availability (log)") +
  ggtitle("Recovery")

## Plot

com_bel_ja_plot <-  (plot_bel_ja_res |  plot_bel_ja_rec)+ 
  plot_annotation(title = "JA- Bellis perennis",
                  theme = theme(plot.title = element_text(hjust = 0.5)))
com_bel_ja_plot

## Log response ratio effect size

## LRR: Positive LRR (recovery > resistance), compound concentration increase during recovery.

## Plantago

# ABA------------------------------------------------------------

pla_ABA_LRR <- data_long %>%
  filter(pla_lan == 1, compound == "aba") %>%
  group_by(species_diversity, waterAv_log,drought_level) %>%
  summarise(
    mean_resistance = mean(concentration[phase == "Resistance"], na.rm = TRUE) + 1e-5,
    mean_recovery   = mean(concentration[phase == "Recovery"], na.rm = TRUE) + 1e-5,
    LRR             = log(mean_recovery / mean_resistance),
    # SE of LRR across replicates
    se_LRR          = sd(log((concentration[phase == "Recovery"] + 1e-5) / 
                             (concentration[phase == "Resistance"] + 1e-5)), na.rm = TRUE) / 
                      sqrt(n()) )

pla_ABA_LRR <- pla_ABA_LRR %>%
  mutate(
    LRR_lower = LRR - 1.96 * se_LRR,
    LRR_upper = LRR + 1.96 * se_LRR )



ggplot(pla_ABA_LRR, aes(x = factor(drought_level), y = LRR, 
                        group = species_diversity, color = species_diversity, fill = species_diversity)) +
  geom_ribbon(aes(ymin = LRR_lower, ymax = LRR_upper), alpha = 0.2, color = NA) +  # shaded CI
  geom_line(linewidth = 1) +
  geom_point(size = 3) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  theme_classic() +
  xlab("Drought level") +
  ylab("Log Response Ratio (LRR)") +
  theme(legend.position = "top")

# Model
null<-lm(LRR~1,data=pla_ABA_LRR)
water<-lm(LRR~waterAv_log,data=pla_ABA_LRR)
div<-lm(LRR~waterAv_log+species_diversity,data=pla_ABA_LRR)
water_div<-lm(LRR~waterAv_log*species_diversity,
                  data=pla_ABA_LRR)


anova(null,water,div,water_div)
shapiro.test(resid(water_div))

pred <- ggpredict(water_div,terms = c("waterAv_log","species_diversity"))

  # 6. Create the plot
  pla_ABA_LRR_plot<- plot(pred) +
    geom_point(data = pla_ABA_LRR,
             aes(x = waterAv_log, 
                 y = LRR,
                 color = species_diversity),
             size = 2,
    inherit.aes = FALSE) +
    geom_line(linewidth = 1) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
    theme_classic() +
    ylim(-1.5,1.5)+
    theme(legend.position = "top")+
     ylab("Log Response Ratio (LRR)") +
    xlab("Water field availability (log)") +
    ggtitle("Effect size")

## Plot

com_Plalan_plot <-  (plot_plalan_res |  plot_plalan_rec|pla_ABA_LRR_plot)+ 
  plot_annotation(title = "ABA -Plantago lanceolata",
                  theme = theme(plot.title = element_text(hjust = 0.5)))
com_Plalan_plot

# JA------------------------------------------------------------

pla_JA_LRR <- data_long %>%
  filter(pla_lan == 1, compound == "ja") %>%
  group_by(species_diversity, waterAv_log,drought_level) %>%
  summarise(
    mean_resistance = mean(concentration[phase == "Resistance"], na.rm = TRUE) + 1e-5,
    mean_recovery   = mean(concentration[phase == "Recovery"], na.rm = TRUE) + 1e-5,
    LRR             = log(mean_recovery / mean_resistance),
    # SE of LRR across replicates
    se_LRR          = sd(log((concentration[phase == "Recovery"] + 1e-5) / 
                             (concentration[phase == "Resistance"] + 1e-5)), na.rm = TRUE) / 
                      sqrt(n()) )

pla_JA_LRR <- pla_JA_LRR %>%
  mutate(
    LRR_lower = LRR - 1.96 * se_LRR,
    LRR_upper = LRR + 1.96 * se_LRR )



ggplot(pla_JA_LRR, aes(x = factor(drought_level), y = LRR, 
                        group = species_diversity, color = species_diversity, fill = species_diversity)) +
  geom_ribbon(aes(ymin = LRR_lower, ymax = LRR_upper), alpha = 0.2, color = NA) +  # shaded CI
  geom_line(linewidth = 1) +
  geom_point(size = 3) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  theme_classic() +
  xlab("Drought level") +
  ylab("Log Response Ratio (LRR)") +
  theme(legend.position = "top")

# Model
null<-lm(LRR~1,data=pla_JA_LRR)
water<-lm(LRR~waterAv_log,data=pla_JA_LRR)
div<-lm(LRR~waterAv_log+species_diversity,data=pla_JA_LRR)
water_div<-lm(LRR~waterAv_log*species_diversity,
                  data=pla_JA_LRR)


anova(null,water,div,water_div)

shapiro.test(resid(water_div))
 pred <- ggpredict(water_div,terms = c("waterAv_log","species_diversity"))

  # 6. Create the plot
  pla_JA_LRR_plot<- plot(pred) +
    geom_point(data = pla_JA_LRR,
             aes(x = waterAv_log, 
                 y = LRR,
                 color = species_diversity),
             size = 2,
    inherit.aes = FALSE) +
    geom_line(linewidth = 1) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
    theme_classic() +
    ylim(-1.5,1.5)+
    theme(legend.position = "top")+
     ylab("Log Response Ratio (LRR)") +
    xlab("Water field availability (log)") +
    ggtitle("Effect size")

 ## Plot

com_Pla_ja_plot <-  (plot_pla_ja_res |  plot_pla_ja_rec|pla_JA_LRR_plot)+ 
  plot_annotation(title = "JA -Plantago lanceolata",
                  theme = theme(plot.title = element_text(hjust = 0.5)))
com_Pla_ja_plot


